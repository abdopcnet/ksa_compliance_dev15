{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-05-28 02:38:18.340710",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 5,
 "is_standard": "Yes",
 "javascript": "frappe.query_reports[\"compare_Sales_with_zatca\"] = {\r\n    \"filters\": [\r\n        {\r\n            \"fieldname\": \"from_date\",\r\n            \"label\": \"\u0645\u0646 \u062a\u0627\u0631\u064a\u062e\",\r\n            \"fieldtype\": \"Date\",\r\n            \"default\": frappe.datetime.month_start()\r\n        },\r\n        {\r\n            \"fieldname\": \"to_date\",\r\n            \"label\": \"\u0625\u0644\u0649 \u062a\u0627\u0631\u064a\u062e\",\r\n            \"fieldtype\": \"Date\",\r\n            \"default\": frappe.datetime.now_date()\r\n        },\r\n        {\r\n            \"fieldname\": \"customer\",\r\n            \"label\": \"\u0627\u0644\u0639\u0645\u064a\u0644\",\r\n            \"fieldtype\": \"Link\",\r\n            \"options\": \"Customer\"\r\n        },\r\n        {\r\n            \"fieldname\": \"integration_status\",\r\n            \"label\": \"\u062d\u0627\u0644\u0629 \u0627\u0644\u062a\u0643\u0627\u0645\u0644\",\r\n            \"fieldtype\": \"Select\",\r\n            \"options\": \"\\nAccepted\\nAccepted with warnings\\nNot Sended\\nNo Sales Invoice\"\r\n        }\r\n    ]\r\n};",
 "letter_head": "",
 "letterhead": null,
 "modified": "2025-11-12 15:37:27.930936",
 "modified_by": "Administrator",
 "module": "KSA Compliance",
 "name": "compare_Sales_with_zatca",
 "owner": "Administrator",
 "prepared_report": 0,
 "query": "import frappe\n\n# -----------------------------------------------------------------------------\n# Report: compare_Sales_with_zatca\n# Type: Script Report\n# Add totals row\n# -----------------------------------------------------------------------------\n\n# Columns definition\ncolumns = [\n    {\"fieldname\": \"posting_date\", \"label\": \"Date\", \"fieldtype\": \"Date\", \"width\": 130},\n    {\"fieldname\": \"name\", \"label\": \"Invoice\", \"fieldtype\": \"Link\", \"options\": \"Sales Invoice\", \"width\": 170},\n    {\"fieldname\": \"grand_total\", \"label\": \"Grand Total\", \"fieldtype\": \"Data\", \"width\": 130},\n    {\"fieldname\": \"total_taxes_and_charges\", \"label\": \"Tax Amount\", \"fieldtype\": \"Data\", \"width\": 130},\n    {\"fieldname\": \"status\", \"label\": \"Status\", \"fieldtype\": \"Data\", \"width\": 130},\n    {\"fieldname\": \"integration_status\", \"label\": \"(ZATCA)\", \"fieldtype\": \"Data\", \"width\": 200}\n]\n\n# Main execution function\ndef execute(filters=None):\n    if not filters:\n        filters = {}\n\n    from_date = filters.get(\"from_date\")\n    to_date = filters.get(\"to_date\")\n    status_filter = filters.get(\"Status\")\n\n    conditions = []\n    params = {}\n\n    # Date range filter\n    if from_date and to_date:\n        conditions.append(\"`tabSales Invoice`.`posting_date` BETWEEN %(from_date)s AND %(to_date)s\")\n        params[\"from_date\"] = from_date\n        params[\"to_date\"] = to_date\n\n    # Status filter\n    if status_filter:\n        conditions.append(\"`tabSales Invoice`.`status` = %(status)s\")\n        params[\"status\"] = status_filter\n\n    where_clause = \"WHERE \" + \" AND \".join(conditions) if conditions else \"\"\n\n    query = f\"\"\"\n        SELECT\n            `tabSales Invoice`.`posting_date` AS posting_date,\n            `tabSales Invoice`.`name` AS name,\n            `tabSales Invoice`.`grand_total` AS grand_total,\n            `tabSales Invoice`.`total_taxes_and_charges` AS total_taxes_and_charges,\n            `tabSales Invoice`.`status` AS status,\n            IF(`tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`,\n               `tabSales Invoice Additional Fields`.`integration_status`, '\u062e\u0637\u0623') AS integration_status\n        FROM `tabSales Invoice`\n        LEFT JOIN `tabSales Invoice Additional Fields`\n          ON `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\n        {where_clause}\n        ORDER BY `tabSales Invoice`.`posting_date` DESC\n    \"\"\"\n\n    data = frappe.db.sql(query, params, as_dict=True)\n\n    # Append totals row\n    total_grand = sum(row.get(\"grand_total\") or 0 for row in data)\n    total_taxes = sum(row.get(\"total_taxes_and_charges\") or 0 for row in data)\n    data.append({\n        \"posting_date\": \"Totals\",\n        \"name\": \"\",\n        \"grand_total\": total_grand,\n        \"total_taxes_and_charges\": total_taxes,\n        \"status\": \"\",\n        \"integration_status\": \"\"\n    })\n\n    return columns, data\n",
 "ref_doctype": "Sales Invoice",
 "report_name": "compare_Sales_with_zatca",
 "report_script": "# \u062a\u0639\u0631\u064a\u0641 \u0627\u0644\u0623\u0639\u0645\u062f\u0629\r\ncolumns = [\r\n    {\r\n        \"fieldname\": \"posting_date\",\r\n        \"label\": \"Date\",\r\n        \"fieldtype\": \"Date\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"name\",\r\n        \"label\": \"Invoice\",\r\n        \"fieldtype\": \"Link\",\r\n        \"options\": \"Sales Invoice\",\r\n        \"width\": 170\r\n    },\r\n    {\r\n        \"fieldname\": \"customer\",\r\n        \"label\": \"Customer\",\r\n        \"fieldtype\": \"Link\",\r\n        \"options\": \"Customer\",\r\n        \"width\": 180\r\n    },\r\n    {\r\n        \"fieldname\": \"grand_total\",\r\n        \"label\": \"Grand Total\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"total_taxes_and_charges\",\r\n        \"label\": \"Tax Amount\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"integration_status\",\r\n        \"label\": \"(ZATCA)\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 200\r\n    }\r\n]\r\n\r\nfrom_date = filters.get(\"from_date\") or frappe.datetime.month_start()\r\nto_date = filters.get(\"to_date\") or frappe.datetime.now_date()\r\ncustomer = filters.get(\"customer\")\r\nintegration_status = filters.get(\"integration_status\")\r\n\r\nquery = \"\"\"\r\nSELECT\r\n  `tabSales Invoice`.`posting_date`,\r\n  `tabSales Invoice`.`name`,\r\n  `tabSales Invoice`.`customer`,\r\n  `tabSales Invoice`.`grand_total`,\r\n  `tabSales Invoice`.`total_taxes_and_charges`,\r\n  CASE\r\n    WHEN `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n      THEN `tabSales Invoice Additional Fields`.`integration_status`\r\n    WHEN `tabSales Invoice Additional Fields`.`sales_invoice` IS NULL\r\n      THEN 'Not Sended'\r\n    ELSE 'No Sales Invoice'\r\n  END AS `integration_status`\r\nFROM `tabSales Invoice`\r\nLEFT JOIN `tabSales Invoice Additional Fields`\r\n  ON `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n\"\"\"\r\n\r\nwhere_conditions = []\r\nparams = {}\r\n\r\nif from_date and to_date:\r\n    where_conditions.append(\"`tabSales Invoice`.`posting_date` BETWEEN %(from_date)s AND %(to_date)s\")\r\n    params[\"from_date\"] = from_date\r\n    params[\"to_date\"] = to_date\r\n\r\nif customer:\r\n    where_conditions.append(\"`tabSales Invoice`.`customer` = %(customer)s\")\r\n    params[\"customer\"] = customer\r\n\r\nif integration_status:\r\n    where_conditions.append(\"\"\"\r\n    (\r\n        CASE\r\n            WHEN `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n                THEN `tabSales Invoice Additional Fields`.`integration_status`\r\n            WHEN `tabSales Invoice Additional Fields`.`sales_invoice` IS NULL\r\n                THEN 'Not Sended'\r\n            ELSE 'No Sales Invoice'\r\n        END\r\n    ) = %(integration_status)s\r\n    \"\"\")\r\n    params[\"integration_status\"] = integration_status\r\n\r\nif where_conditions:\r\n    query = query + \" WHERE \" + \" AND \".join(where_conditions)\r\n\r\n# \u062a\u0639\u0631\u064a\u0641 \u0627\u0644\u0623\u0639\u0645\u062f\u0629\r\ncolumns = [\r\n    {\r\n        \"fieldname\": \"posting_date\",\r\n        \"label\": \"Date\",\r\n        \"fieldtype\": \"Date\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"name\",\r\n        \"label\": \"Invoice\",\r\n        \"fieldtype\": \"Link\",\r\n        \"options\": \"Sales Invoice\",\r\n        \"width\": 170\r\n    },\r\n    {\r\n        \"fieldname\": \"customer\",\r\n        \"label\": \"Customer\",\r\n        \"fieldtype\": \"Link\",\r\n        \"options\": \"Customer\",\r\n        \"width\": 180\r\n    },\r\n    {\r\n        \"fieldname\": \"grand_total\",\r\n        \"label\": \"Grand Total\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"total_taxes_and_charges\",\r\n        \"label\": \"Tax Amount\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 130\r\n    },\r\n    {\r\n        \"fieldname\": \"integration_status\",\r\n        \"label\": \"(ZATCA)\",\r\n        \"fieldtype\": \"Data\",\r\n        \"width\": 200\r\n    }\r\n]\r\n\r\nfrom_date = filters.get(\"from_date\") or frappe.datetime.month_start()\r\nto_date = filters.get(\"to_date\") or frappe.datetime.now_date()\r\ncustomer = filters.get(\"customer\")\r\nintegration_status = filters.get(\"integration_status\")\r\n\r\nquery = \"\"\"\r\nSELECT\r\n  `tabSales Invoice`.`posting_date`,\r\n  `tabSales Invoice`.`name`,\r\n  `tabSales Invoice`.`customer`,\r\n  `tabSales Invoice`.`grand_total`,\r\n  `tabSales Invoice`.`total_taxes_and_charges`,\r\n  CASE\r\n    WHEN `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n      THEN `tabSales Invoice Additional Fields`.`integration_status`\r\n    WHEN `tabSales Invoice Additional Fields`.`sales_invoice` IS NULL\r\n      THEN 'Not Sended'\r\n    ELSE 'No Sales Invoice'\r\n  END AS `integration_status`\r\nFROM `tabSales Invoice`\r\nLEFT JOIN `tabSales Invoice Additional Fields`\r\n  ON `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n\"\"\"\r\n\r\nwhere_conditions = []\r\nparams = {}\r\n\r\nif from_date and to_date:\r\n    where_conditions.append(\"`tabSales Invoice`.`posting_date` BETWEEN %(from_date)s AND %(to_date)s\")\r\n    params[\"from_date\"] = from_date\r\n    params[\"to_date\"] = to_date\r\n\r\nif customer:\r\n    where_conditions.append(\"`tabSales Invoice`.`customer` = %(customer)s\")\r\n    params[\"customer\"] = customer\r\n\r\nif integration_status:\r\n    where_conditions.append(\"\"\"\r\n    (\r\n        CASE\r\n            WHEN `tabSales Invoice Additional Fields`.`sales_invoice` = `tabSales Invoice`.`name`\r\n                THEN `tabSales Invoice Additional Fields`.`integration_status`\r\n            WHEN `tabSales Invoice Additional Fields`.`sales_invoice` IS NULL\r\n                THEN 'Not Sended'\r\n            ELSE 'No Sales Invoice'\r\n        END\r\n    ) = %(integration_status)s\r\n    \"\"\")\r\n    params[\"integration_status\"] = integration_status\r\n\r\nif where_conditions:\r\n    query = query + \" WHERE \" + \" AND \".join(where_conditions)\r\n\r\nmydata = frappe.db.sql(query, params, as_dict=True)\r\n\r\n# Data\r\ndata = columns, mydata",
 "report_type": "Script Report",
 "roles": [],
 "timeout": 0
}